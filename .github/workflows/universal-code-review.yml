name: Universal Automated Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master, develop]

env:
  # í”„ë¡œì íŠ¸ë³„ ì„¤ì • - í™˜ê²½ë³€ìˆ˜ë¡œ ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥
  PROJECT_TYPE: ${{ vars.PROJECT_TYPE || 'ios-swift' }}
  ARCHITECTURE: ${{ vars.ARCHITECTURE || 'clean-architecture' }}
  REVIEW_DEPTH: ${{ vars.REVIEW_DEPTH || 'comprehensive' }}
  COVERAGE_THRESHOLD: ${{ vars.COVERAGE_THRESHOLD || '70' }}

jobs:
  # í”„ë¡œì íŠ¸ íƒ€ì… ê°ì§€
  detect-project:
    runs-on: ubuntu-latest
    outputs:
      project-type: ${{ steps.detect.outputs.project-type }}
      has-ios: ${{ steps.detect.outputs.has-ios }}
      has-android: ${{ steps.detect.outputs.has-android }}
      has-flutter: ${{ steps.detect.outputs.has-flutter }}
      has-web: ${{ steps.detect.outputs.has-web }}
      has-react-native: ${{ steps.detect.outputs.has-react-native }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect Project Type
        id: detect
        run: |
          # iOS í”„ë¡œì íŠ¸ ê°ì§€
          if [[ -f "*.xcodeproj/project.pbxproj" ]] || [[ -f "Package.swift" ]] || [[ -d "*.xcworkspace" ]]; then
            echo "has-ios=true" >> $GITHUB_OUTPUT
          fi

          # Android í”„ë¡œì íŠ¸ ê°ì§€
          if [[ -f "build.gradle" ]] || [[ -f "build.gradle.kts" ]] || [[ -f "settings.gradle" ]]; then
            echo "has-android=true" >> $GITHUB_OUTPUT
          fi

          # Flutter í”„ë¡œì íŠ¸ ê°ì§€
          if [[ -f "pubspec.yaml" ]] && grep -q "flutter:" pubspec.yaml; then
            echo "has-flutter=true" >> $GITHUB_OUTPUT
          fi

          # React Native í”„ë¡œì íŠ¸ ê°ì§€
          if [[ -f "package.json" ]] && grep -q "react-native" package.json; then
            echo "has-react-native=true" >> $GITHUB_OUTPUT
          fi

          # Web í”„ë¡œì íŠ¸ ê°ì§€
          if [[ -f "package.json" ]] && (grep -q "react\|vue\|angular\|next\|nuxt" package.json); then
            echo "has-web=true" >> $GITHUB_OUTPUT
          fi

          # ë©”ì¸ í”„ë¡œì íŠ¸ íƒ€ì… ê²°ì •
          if [[ "${{ steps.detect.outputs.has-ios }}" == "true" ]]; then
            echo "project-type=ios" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.detect.outputs.has-android }}" == "true" ]]; then
            echo "project-type=android" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.detect.outputs.has-flutter }}" == "true" ]]; then
            echo "project-type=flutter" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.detect.outputs.has-react-native }}" == "true" ]]; then
            echo "project-type=react-native" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.detect.outputs.has-web }}" == "true" ]]; then
            echo "project-type=web" >> $GITHUB_OUTPUT
          else
            echo "project-type=unknown" >> $GITHUB_OUTPUT
          fi

  # ë²”ìš© ì½”ë“œ ë¦¬ë·°
  automated-review:
    needs: detect-project
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Load Review Configuration
        id: config
        run: |
          if [[ -f ".github/universal-codereview-config.json" ]]; then
            echo "Using universal config"
            cp .github/universal-codereview-config.json .github/active-config.json
          elif [[ -f ".github/codereview-config.json" ]]; then
            echo "Using project-specific config"
            cp .github/codereview-config.json .github/active-config.json
          else
            echo "Using default config"
            echo '{"reviewRules":{"projectType":"'${{ needs.detect-project.outputs.project-type }}'"}}' > .github/active-config.json
          fi

      - name: Universal Code Quality Checks
        env:
          PROJECT_TYPE: ${{ needs.detect-project.outputs.project-type }}
        run: |
          echo "ğŸ” Running universal code quality checks..."

          # í•˜ë“œì½”ë”©ëœ ë¬¸ìì—´ ì²´í¬ (ë‹¤êµ­ì–´í™”)
          echo "Checking for hardcoded strings..."
          if find . -name "*.swift" -o -name "*.kt" -o -name "*.dart" -o -name "*.ts" -o -name "*.js" | \
             xargs grep -l '"[ê°€-í£]"' 2>/dev/null; then
            echo "::warning::Hardcoded strings found. Consider using localization."
          fi

          # ì•„í‚¤í…ì²˜ ë ˆì´ì–´ ìœ„ë°˜ ì²´í¬
          echo "Checking architecture layer violations..."
          case "$PROJECT_TYPE" in
            "ios")
              # Data layerê°€ Presentation import ì²´í¬
              if find . -path "*/Data/*" -name "*.swift" -exec grep -l "import.*Presentation" {} \; 2>/dev/null | head -1; then
                echo "::error::Data layer should not import Presentation layer."
              fi
              ;;
            "android")
              # Similar checks for Android
              if find . -path "*/data/*" -name "*.kt" -exec grep -l "import.*presentation" {} \; 2>/dev/null | head -1; then
                echo "::error::Data layer should not import Presentation layer."
              fi
              ;;
          esac

      - name: Run Platform-Specific Checks
        env:
          PROJECT_TYPE: ${{ needs.detect-project.outputs.project-type }}
        run: |
          case "$PROJECT_TYPE" in
            "ios")
              echo "ğŸ Running iOS-specific checks..."
              # SwiftLintê°€ ìˆìœ¼ë©´ ì‹¤í–‰
              if command -v swiftlint &> /dev/null; then
                swiftlint lint --reporter github-actions-logging || true
              fi

              # forEach addSubview íŒ¨í„´ ì²´í¬
              if grep -r "forEach.*addSubview" . --include="*.swift" 2>/dev/null; then
                echo "::error::Prohibited forEach addSubview pattern found. Use individual addSubview calls."
              fi
              ;;

            "android")
              echo "ğŸ¤– Running Android-specific checks..."
              # ktlintê°€ ìˆìœ¼ë©´ ì‹¤í–‰
              if command -v ktlint &> /dev/null; then
                ktlint --reporter=checkstyle || true
              fi
              ;;

            "flutter")
              echo "ğŸ¦‹ Running Flutter-specific checks..."
              if command -v flutter &> /dev/null; then
                flutter analyze || true
              fi
              ;;

            "react-native"|"web")
              echo "âš›ï¸ Running JavaScript/TypeScript checks..."
              if [[ -f "package.json" ]]; then
                npm install
                if npm run lint &> /dev/null; then
                  npm run lint || true
                fi
              fi
              ;;
          esac

  # iOS ì „ìš© ê²€ì¦
  ios-validation:
    if: needs.detect-project.outputs.has-ios == 'true'
    needs: detect-project
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup iOS Environment
        run: |
          # Tuistê°€ ìˆìœ¼ë©´ ì„¤ì¹˜
          if [[ -f "Tuist/Config.swift" ]]; then
            curl -Ls https://install.tuist.io | bash
            tuist generate --no-open
          fi

      - name: iOS Build Validation
        run: |
          # Xcode í”„ë¡œì íŠ¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸
          if ls *.xcworkspace 1> /dev/null 2>&1; then
            WORKSPACE=$(ls *.xcworkspace | head -1)
            xcodebuild -workspace "$WORKSPACE" -scheme $(xcodebuild -workspace "$WORKSPACE" -list | grep -A 1 "Schemes:" | tail -1 | xargs) -destination 'platform=iOS Simulator,name=iPhone 15' build-for-testing || true
          elif ls *.xcodeproj 1> /dev/null 2>&1; then
            PROJECT=$(ls *.xcodeproj | head -1)
            xcodebuild -project "$PROJECT" -scheme $(xcodebuild -project "$PROJECT" -list | grep -A 1 "Schemes:" | tail -1 | xargs) -destination 'platform=iOS Simulator,name=iPhone 15' build-for-testing || true
          fi

  # Android ì „ìš© ê²€ì¦
  android-validation:
    if: needs.detect-project.outputs.has-android == 'true'
    needs: detect-project
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Android Environment
        uses: android-actions/setup-android@v3

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Android Build Validation
        run: |
          if [[ -f "gradlew" ]]; then
            ./gradlew assembleDebug --no-daemon || true
          fi

  # Flutter ì „ìš© ê²€ì¦
  flutter-validation:
    if: needs.detect-project.outputs.has-flutter == 'true'
    needs: detect-project
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'

      - name: Flutter Validation
        run: |
          flutter pub get
          flutter analyze
          flutter test || true

  # ë³´ì•ˆ ìŠ¤ìº”
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Security Scan
        run: |
          echo "ğŸ”’ Running security checks..."

          # API í‚¤ë‚˜ ì‹œí¬ë¦¿ ì²´í¬
          if grep -r "sk-\|pk_\|AIza\|AKIA\|ya29" . --exclude-dir=.git --exclude="*.md" 2>/dev/null; then
            echo "::error::Potential API keys or secrets found in code."
          fi

          # í•˜ë“œì½”ë”©ëœ URL ì²´í¬
          if grep -r "http://\|ftp://" . --include="*.swift" --include="*.kt" --include="*.dart" --include="*.js" --include="*.ts" 2>/dev/null; then
            echo "::warning::Insecure HTTP URLs found. Consider using HTTPS."
          fi

  # ì˜ì¡´ì„± ì²´í¬
  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Dependencies
        run: |
          echo "ğŸ“¦ Checking dependencies..."

          # ìˆœí™˜ ì˜ì¡´ì„± ì²´í¬
          if [[ -f "Package.swift" ]]; then
            echo "Checking Swift package dependencies..."
            # Swift Package Manager ì˜ì¡´ì„± ì²´í¬
          fi

          if [[ -f "package.json" ]]; then
            echo "Checking npm dependencies..."
            npm audit || true
          fi

          if [[ -f "pubspec.yaml" ]]; then
            echo "Checking Flutter dependencies..."
            # Flutter ì˜ì¡´ì„± ì²´í¬
          fi

  # ë¦¬ë·° ìš”ì•½ ìƒì„±
  generate-review-summary:
    needs: [detect-project, automated-review]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Review Summary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“‹ Generating comprehensive review summary..."

          # PR ì •ë³´ ìˆ˜ì§‘
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PROJECT_TYPE="${{ needs.detect-project.outputs.project-type }}"

          # ë¦¬ë·° ì ìˆ˜ ê³„ì‚° (ì˜ˆì‹œ)
          ARCHITECTURE_SCORE=8
          CODE_QUALITY_SCORE=7
          UI_SCORE=9
          OVERALL_SCORE=$(( (ARCHITECTURE_SCORE + CODE_QUALITY_SCORE + UI_SCORE) / 3 ))

          # GitHubì— ì½”ë©˜íŠ¸ ì‘ì„±
          gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments -f body="
          ## ğŸ¯ Universal Automated Code Review - PR #$PR_NUMBER

          **í”„ë¡œì íŠ¸ íƒ€ì…:** $PROJECT_TYPE
          **ì „ì²´ ì ìˆ˜:** $OVERALL_SCORE/10

          ### ğŸ“Š Code Quality Metrics
          - **Architecture:** $ARCHITECTURE_SCORE/10
          - **Code Quality:** $CODE_QUALITY_SCORE/10
          - **UI/UX:** $UI_SCORE/10

          ìì„¸í•œ ë¶„ì„ ê²°ê³¼ëŠ” ìœ„ì˜ ì²´í¬ë“¤ì„ ì°¸ê³ í•´ì£¼ì„¸ìš”.
          "